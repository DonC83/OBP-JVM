# OBP-JVM
A set of libraries and a demo application.
*Not quite ready for release.*

## Design

This is a redesign of
[OBP-API project's](https://github.com/OpenBankProject/OBP-API) `code.bankconnectors.Connector`.
The connector is used to communicate with extensions/plugins/backends that are
independently developed.

The goals are:

  * Support multiple versions of the API
  * Pluggable encoding of messages (defaulting to JSON)
  * Pluggable transports
    * Kafka
    * In memory (directly linked to OBP-API)
  * Easy testing
  * Provide a demo

**Your feedback is very much appreciated**

## Quick start

Take a look at

```
obp-ri-demo/src/test/java/com/tesobe/obp/demo/south/LocalDefaultConnectorTest.java
```

The `factory` provides the *North* side of the connection.

Use it to select the version of the connector (currently only `Version.legacy` which means unversioned) and the encoding to use (currently only `Encoding.json`).

The `responder` provides the *South* side of the connection.

Implement the interface `com.tesobe.obp.transport.spi.Receiver` or subclass `com.tesobe.obp.transport.spi.LegacyResponder` to get started.

The `DemoResponder` subclasses `LegacyResponder`.

```java
  @Before public void setup()
  {
    factory = Transport.defaultFactory().orElseThrow(RuntimeException::new);
    responder = new DemoResponder(factory.decoder(), factory.encoder());
  }
```

This test uses synchronous, in memory communitcation by passing a function to `factory.connector` that directly calls the (south side's) responder when receiving a request.

The two lists of banks will receive the results of the api calls.

`connector.getPublicBanks()` is a call that is executed on the *north* side, normally triggered by a REST call. It returns the response generated by the *south* side that was encoded, transmitted, and decoded by the library. It will result in a call on the provider `com.tesobe.obp.demo.south.DemoResponder`.

Run the tests to see the log output.

```java
  @Test public void synchronous() throws InterruptedException
  {
    Connector connector = factory
      .connector(request -> responder.respond(request));

    List<Connector.Bank> publicBanks = new ArrayList<>();
    List<Connector.Bank> privateBanks = new ArrayList<>();

    connector.getPublicBanks().forEach(publicBanks::add);
    connector.getPrivateBanks(Users.charles).forEach(privateBanks::add);

    Assert.assertThat(publicBanks.size(), Is.is(2));
    Assert.assertThat(privateBanks.size(), Is.is(1));
  }
```

Integration test are configured to only run from the command line:
`mvn failsafe:integration-test`

## Kafka

We are using Kafka version **0.10.0.0**.
Start the servers and add the topics configured in your copy of OBP-API.
The names of the topics are specified in `OBP-API/src/main/resources/props/default.props`.
Substitute the name of your `.props` file. By default they are _Request_ and _Response_.

```
bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic Request
bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic Response
```

For testing reduce the retention time to, for example, one minute

```
bin/kafka-configs.sh --zookeeper localhost:2181 --entity-type topics --alter --add-config retention.ms=1000 --entity-name Request
bin/kafka-configs.sh --zookeeper localhost:2181 --entity-type topics --alter --add-config retention.ms=1000 --entity-name Response
```

If there is no props file in `OBP-API/src/main/resources/props/`, then `default.props` copied from `sample.props.template` will do.
In the `.props` file these lines are required:

```
connector=kafka
kafka.zookeeper_host=localhost:2181
kafka.request_topic=Request
kafka.response_topic=Response
```

Then start the server

```
cd OBP_API
mvn jetty:run
```

These are the default property files use by the south side demo:

```
obp-ri-demo/src/main/resources/com/tesobe/obp/demo/south/consumer.props
obp-ri-demo/src/main/resources/com/tesobe/obp/demo/south/producer.props
```

Command line flags for the south demo

```
java -jar obp-ri-demo/target/obp-ri-demo-2016.0-SNAPSHOT-jar-with-dependencies.jar -h
Option                             Description
------                             -----------
-?, -h, --help                     This message.
-c, --consumer <CONSUMER>          Consumer Configuration (default: consumer.
                                     props)
--consumer-topic <CONSUMER_TOPIC>  Consumer Topic (default: Request)
-p, --producer <PRODUCER>          Producer Configuration (default: producer.
                                     props)
--producer-topic <PRODUCER_TOPIC>  Producer Topic (default: Response)
```

Start the south demo

```
java -jar obp-ri-demo/target/obp-ri-demo-2016.0-SNAPSHOT-jar-with-dependencies.jar&
```

Try a request

```
http://localhost:8080/obp/v2.0.0/banks
```

Checking compatability with OBP-API with `KafkaMappedConnector.scala`

```
curl -v -H "Accept:application/json" -H "Content-Type:application/json" -X GET http://localhost:8080/obp/v2.0.0/banks
curl -v -H "Accept:application/json" -H "Content-Type:application/json" -X GET http://localhost:8080/obp/v2.0.0/banks

```
